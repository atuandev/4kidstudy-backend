// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  LEARNER
}

enum Gender {
  MALE
  FEMALE
  UNSET
}

enum LessonStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ExerciseType {
  SELECT_IMAGE // Chọn ảnh đúng
  MULTIPLE_CHOICE // Trắc nghiệm chữ
  MATCHING // Ghép cặp
  LISTENING // Nghe - chọn đáp án
  PRONUNCIATION // Luyện phát âm (AI)
}

enum MediaType {
  IMAGE
  AUDIO
  VIDEO
  OTHER
}

enum XPSource {
  LESSON_COMPLETE
  EXERCISE_CORRECT
  STREAK_BONUS
  ADMIN_ADJUST
  OTHER
}

enum GradeLevel {
  GRADE_1
  GRADE_2
  GRADE_3
  GRADE_4
  GRADE_5
}

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  name         String
  passwordHash String?
  avatarUrl    String?
  dob          DateTime?
  gender       Gender    @default(UNSET)
  role         UserRole  @default(LEARNER)

  // Học tập
  xp         Int     @default(0)
  streakDays Int     @default(0)
  isActive   Boolean @default(true)

  // Quan hệ
  attempts   Attempt[]
  xpLogs     XPLog[]
  streakLogs StreakLog[]
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([role])
}

model Topic {
  id          Int        @id @default(autoincrement())
  title       String
  description String?
  grade       GradeLevel
  order       Int        @default(0)
  coverImage  String?
  isActive    Boolean    @default(true)

  lessons        Lesson[]
  flashcards     Flashcard[]
  sentenceImages SentenceImage[]
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  @@unique([title, grade])
  @@index([grade, isActive])
}

model Lesson {
  id          Int          @id @default(autoincrement())
  topicId     Int
  topic       Topic        @relation(fields: [topicId], references: [id], onDelete: Cascade)
  title       String
  description String?
  isCompleted Boolean      @default(false)
  order       Int          @default(0)
  status      LessonStatus @default(DRAFT)

  // Lý thuyết tóm tắt
  theoryText    String? // markdown/plain
  phoneticsNote String?
  grammarNote   String?
  audioUrl      String?
  coverImage    String?

  exercises Exercise[]
  attempts  Attempt[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@unique([topicId, order])
  @@index([topicId, status])
}

model Exercise {
  id       Int          @id @default(autoincrement())
  lessonId Int
  lesson   Lesson       @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  type     ExerciseType
  order    Int          @default(0)

  // Nội dung/lời dẫn chung
  prompt     String? // câu hỏi/đề bài
  imageUrl   String? // SELECT_IMAGE / MULTIPLE_CHOICE minh họa
  audioUrl   String? // LISTENING prompt
  targetText String? // đích: từ/cụm cần đọc (PRONUNCIATION) hoặc đáp án chuẩn (LISTENING)
  hintEn     String?
  hintVi     String?
  points     Int     @default(10)
  difficulty Int     @default(1) // 1-3

  // Quan hệ
  options ExerciseOption[] // MULTIPLE_CHOICE / SELECT_IMAGE / MATCHING (dùng matchKey)
  details AttemptDetail[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([lessonId, order])
  @@index([lessonId, type])
}

model ExerciseOption {
  id         Int      @id @default(autoincrement())
  exerciseId Int
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  text       String?
  imageUrl   String?
  audioUrl   String?
  isCorrect  Boolean  @default(false)
  order      Int      @default(0)

  // Với MATCHING: các phần tử có cùng matchKey là một cặp đúng
  matchKey String? // ví dụ "pair_1" cho cả hình và chữ

  // Back relation for AttemptDetail.selectedOption
  selectedBy AttemptDetail[]

  @@unique([exerciseId, order])
  @@index([exerciseId])
  @@index([matchKey])
}

// Flashcard tách riêng (dùng cho "Học tiếng Anh" → flashcard)
model Flashcard {
  id        Int     @id @default(autoincrement())
  topicId   Int
  topic     Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  term      String
  phonetic  String?
  meaningVi String
  exampleEn String?
  exampleVi String?
  imageUrl  String?
  audioUrl  String?
  order     Int     @default(0)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([topicId, order])
  @@index([topicId, isActive])
}

model SentenceImage {
  id       Int     @id @default(autoincrement())
  topicId  Int
  topic    Topic   @relation(fields: [topicId], references: [id], onDelete: Cascade)
  imageUrl String
  audioUrl String?
  order    Int     @default(0)
  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sentences Sentence[]

  @@unique([topicId, order])
}

model Sentence {
  id              Int           @id @default(autoincrement())
  sentenceImageId Int
  sentenceImage   SentenceImage @relation(fields: [sentenceImageId], references: [id], onDelete: Cascade)
  text            String
  meaningVi       String?
  hintVi          String?
  audioUrl        String?
  order           Int           @default(0)
  isActive        Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([sentenceImageId, order])
}

// Lượt làm bài / thống kê tiến trình
model Attempt {
  id       Int    @id @default(autoincrement())
  userId   Int
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lessonId Int
  lesson   Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  durationSec Int?
  totalScore     Int   @default(0)
  maxScore       Int   @default(0)
  accuracyPct    Float @default(0)
  correctCount   Int   @default(0)
  incorrectCount Int   @default(0)
  skipCount      Int   @default(0)

  attemptNumber Int     @default(1)
  isCompleted   Boolean @default(false)

  details   AttemptDetail[]
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@index([userId])
  @@index([lessonId])
  @@index([userId, lessonId])
}

model AttemptDetail {
  id         Int      @id @default(autoincrement())
  attemptId  Int
  attempt    Attempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  exerciseId Int
  exercise   Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  isCorrect        Boolean
  selectedOptionId Int?
  selectedOption   ExerciseOption? @relation(fields: [selectedOptionId], references: [id])

  timeSec   Int?
  points    Int  @default(0)
  maxPoints Int  @default(10)
  attempts Int @default(1)

  pronunciation PronunciationScore?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([attemptId])
  @@index([exerciseId])
  @@index([attemptId, exerciseId])
  @@index([exerciseId, isCorrect])
  @@index([isCorrect, createdAt])
}

model PronunciationScore {
  id              Int           @id @default(autoincrement())
  attemptDetailId Int           @unique
  detail          AttemptDetail @relation(fields: [attemptDetailId], references: [id], onDelete: Cascade)

  accuracy     Float?
  fluency      Float?
  completeness Float?
  prosody      Float?
  overall      Float?

  rawJson  Json?
  audioUrl String?

  createdAt DateTime @default(now())
}

model XPLog {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount     Int
  source     XPSource @default(OTHER)
  lessonId   Int?
  exerciseId Int?
  createdAt  DateTime @default(now())

  @@index([userId, createdAt])
}

model StreakLog {
  id       Int      @id @default(autoincrement())
  userId   Int
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  day      DateTime
  xpEarned Int      @default(0)

  @@unique([userId, day])
  @@index([day])
}
